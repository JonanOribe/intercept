name: Quality Gate - Test Coverage Monitoring

on:
  push:
    branches: [ main, github-actions ]
  pull_request:
    branches: [ main ]

jobs:
  coverage-monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build and Run Tests in Docker
        run: |
          # Build using the specific test Dockerfile located in .github/
          # The "." at the end is the context, allowing Docker to see your app code
          docker build -f .github/tester/Dockerfile.test -t coverage-tester .
          
          # Run tests and capture output
          docker run --name runner coverage-tester > test_output.txt || true
          
          # Extract the total percentage from the output
          COVERAGE=$(grep "TOTAL" test_output.txt | awk '{print $NF}' | tr -d '%')
          
          # Default to 0 if extraction fails to prevent script errors
          if [ -z "$COVERAGE" ]; then COVERAGE=0; fi
          
          echo "CURRENT_COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: Update README Coverage Badge
        run: |
          PERCENTAGE=${{ env.CURRENT_COVERAGE }}
          
          # Color thresholds for the badge
          COLOR="red"
          if [ "$PERCENTAGE" -ge 50 ]; then COLOR="yellow"; fi
          if [ "$PERCENTAGE" -ge 80 ]; then COLOR="brightgreen"; fi
          
          echo "Updating README with $PERCENTAGE% coverage ($COLOR color)"
          
          # Updates the <img> tag URL in your README.md
          sed -i "s/coverage-[0-9]\{1,3\}%25-[a-z]\{1,15\}?style/coverage-$PERCENTAGE%25-$COLOR?style/g" README.md

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update test coverage badge to ${{ env.CURRENT_COVERAGE }}% [skip ci]"
          file_pattern: 'README.md'