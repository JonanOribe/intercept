name: Quality Gate - Test Coverage Monitoring

on:
  push:
    branches: [ main, github-actions ] # Added your current branch for testing
  pull_request:
    branches: [ main ]

jobs:
  coverage-monitor:
    runs-on: ubuntu-latest
    # Essential for the auto-commit action to push changes back
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build and Run Tests in Docker
        run: |
          docker build -t coverage-tester .
          # We use "|| true" so the workflow continues even if tests are failing
          docker run --name runner coverage-tester > test_output.txt || true
          
          # Extracts the number from a line like "TOTAL  80%"
          COVERAGE=$(grep "TOTAL" test_output.txt | awk '{print $NF}' | tr -d '%')
          
          # Default to 0 if extraction fails
          if [ -z "$COVERAGE" ]; then COVERAGE=0; fi
          
          echo "CURRENT_COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: Update README Coverage Badge
        run: |
          PERCENTAGE=${{ env.CURRENT_COVERAGE }}
          
          # Logic for dynamic colors
          COLOR="red"
          if [ "$PERCENTAGE" -ge 50 ]; then COLOR="yellow"; fi
          if [ "$PERCENTAGE" -ge 80 ]; then COLOR="brightgreen"; fi
          
          echo "Updating README with $PERCENTAGE% coverage ($COLOR color)"
          
          # This regex specifically targets the coverage badge inside the <img> tag
          sed -i "s/coverage-[0-9]\{1,3\}%25-[a-z]\{1,15\}?style/coverage-$PERCENTAGE%25-$COLOR?style/g" README.md

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update test coverage badge to ${{ env.CURRENT_COVERAGE }}% [skip ci]"
          file_pattern: 'README.md'